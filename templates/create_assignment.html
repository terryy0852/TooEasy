{% extends "base.html" %}

{% block title %}{{ _('创建作业') }} - {{ _('作业管理系统') }}{% endblock %}

{% block content %}
    <h2 style="margin-bottom: 2rem; color: var(--primary-color);">{{ _('创建新作业') }}</h2>
    
    <form method="POST" enctype="multipart/form-data">
        <div class="form-group">
            <label for="title">{{ _('作业标题') }}</label>
            <input type="text" id="title" name="title" required>
        </div>
        
        <div class="form-group">
            <label for="description">{{ _('作业描述') }}</label>
            <textarea id="description" name="description" rows="5" required></textarea>
        </div>
        
        <div class="form-group">
            <label for="file">{{ _('上传文件（可选）') }}</label>
            <input type="file" id="file" name="file">
            <p style="color: #666; font-size: 0.875rem; margin-top: 0.5rem;">
                {{ _('支持的格式：txt, pdf, doc, docx, xls, xlsx, ppt, pptx, zip') }}
            </p>
        </div>
        
        <div class="form-group">
            <label for="student_picker">{{ _('分配给学生') }}</label>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
                <select id="student_picker" style="flex: 1;">
                    <option value="">{{ _('选择学生…') }}</option>
                    {% for s in students %}
                        <option value="{{ s.id }}">{{ s.username }} (ID: {{ s.id }})</option>
                    {% endfor %}
                </select>
                <button type="button" class="btn btn-secondary" onclick="addStudent()">{{ _('添加') }}</button>
                <button type="button" class="btn btn-outline" onclick="clearStudents()" style="margin-left: 0.25rem;">{{ _('清除') }}</button>
            </div>
            <div id="selected_students_container" style="margin-top: 0.5rem; display: flex; flex-wrap: wrap; gap: 0.5rem;"></div>
            <div id="hidden_inputs_container"></div>
            <p style="color: #666; font-size: 0.875rem; margin-top: 0.5rem;">
                {{ _('选择多个学生；使用下拉菜单逐个添加') }}
            </p>
        </div>

        <script>
        function addStudent(){
            var picker = document.getElementById('student_picker');
            var id = picker.value;
            if(!id) return;
            var hidden = document.getElementById('hidden_inputs_container');
            // Prevent duplicates
            if(hidden.querySelector('input[name="assigned_students"][value="'+id+'"]')) return;
            var name = picker.options[picker.selectedIndex].text;
            // Create visual tag
            var tag = document.createElement('span');
            tag.textContent = name;
            tag.style = 'background:#eef; color:#334; padding:4px 8px; border-radius:12px; display:inline-flex; align-items:center;';
            // Hidden input
            var hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'assigned_students';
            hiddenInput.value = id;
            // Remove button
            var remove = document.createElement('button');
            remove.type = 'button';
            remove.textContent = '×';
            remove.style = 'margin-left:6px; border:none; background:transparent; cursor:pointer;';
            remove.onclick = function(){ hiddenInput.remove(); tag.remove(); };
            tag.appendChild(remove);
            document.getElementById('selected_students_container').appendChild(tag);
            hidden.appendChild(hiddenInput);
            // Reset picker
            picker.value = '';
        }

        function clearStudents(){
            document.getElementById('selected_students_container').innerHTML='';
            var hidden = document.getElementById('hidden_inputs_container');
            hidden.querySelectorAll('input[name="assigned_students"]').forEach(function(el){ el.remove(); });
        }
        </script>

        <div class="form-group">
            <label for="due_date">{{ _('截止日期（可选）') }}</label>
            <input type="date" id="due_date" name="due_date">
        </div>
        
        <div class="form-group">
            <button type="submit" class="btn btn-primary">{{ _('创建作业') }}</button>
            <a href="{{ url_for('tutor_dashboard', lang=request.args.get('lang')) }}" class="btn btn-outline" style="margin-left: 1rem;">{{ _('取消') }}</a>
        </div>
    </form>
{% endblock %}