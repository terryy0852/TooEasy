{% extends "base.html" %}

{% block title %}{{ _('教师仪表盘') }} - {{ _('作业管理系统') }}{% endblock %}

{% block content %}
    <div class="dashboard-header">
        <h1 class="dashboard-title">{{ _('教师仪表盘') }}</h1>
        <a href="{{ url_for('create_assignment') }}" class="btn btn-primary">{{ _('创建新作业') }}</a>
    </div>

    <div class="card" style="margin-bottom: 1rem; border: 2px solid var(--secondary-color); background: #fffef2;">
        <h3 style="margin-bottom: 0.75rem; color:#333;">{{ _('Filters') }}</h3>
        <form method="get" action="{{ url_for('tutor_dashboard') }}">
            <div class="form-group">
                <label for="status">{{ _('Status') }}</label>
                <select id="status" name="status">
                    <option value="" {% if not status %}selected{% endif %}>{{ _('All') }}</option>
                    <option value="graded" {% if status == 'graded' %}selected{% endif %}>{{ _('Graded') }}</option>
                    <option value="ungraded" {% if status == 'ungraded' %}selected{% endif %}>{{ _('Ungraded') }}</option>
                </select>
            </div>
            <div class="form-group">
                <label for="student_id">{{ _('Student') }}</label>
                <select id="student_id" name="student_id">
                    <option value="" {% if not student_id %}selected{% endif %}>{{ _('All') }}</option>
                    {% for s in students %}
                        <option value="{{ s.id }}" {% if student_id and s.id == student_id|int %}selected{% endif %}>{{ s.username }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="assignment">{{ _('Assignment') }}</label>
                <input id="assignment" name="assignment" type="text" value="{{ assignment_q }}" placeholder="{{ _('Search by assignment') }}" />
            </div>
            <button type="submit" class="btn btn-secondary">{{ _('Apply Filters') }}</button>
        </form>
        <div class="form-group" style="margin-top: 0.75rem;">
            <label for="quickSearch">{{ _('Quick Search') }}</label>
            <input id="quickSearch" type="text" placeholder="{{ _('Quick search in table') }}" />
        </div>
    </div>

    <h2 style="margin-bottom: 0.5rem;">{{ _('All Submissions') }}</h2>

    {% if submissions %}
        <div class="card" style="overflow-x:auto;">
            <table id="submissionsTable" style="width:100%; border-collapse: collapse;">
                <thead>
                    <tr>
                        <th style="text-align:left; padding: 0.5rem; border-bottom: 1px solid #eee;">{{ _('Student') }}</th>
                        <th style="text-align:left; padding: 0.5rem; border-bottom: 1px solid #eee;">{{ _('Assignment') }}</th>
                        <th style="text-align:left; padding: 0.5rem; border-bottom: 1px solid #eee;">{{ _('Submitted At') }}</th>
                        <th style="text-align:left; padding: 0.5rem; border-bottom: 1px solid #eee;">{{ _('Status') }}</th>
                        <th style="text-align:left; padding: 0.5rem; border-bottom: 1px solid #eee;">{{ _('Score') }}</th>
                        <th style="text-align:left; padding: 0.5rem; border-bottom: 1px solid #eee;">{{ _('Actions') }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for submission in submissions %}
                        <tr>
                            <td style="padding: 0.5rem;">{{ submission.student.username }}</td>
                            <td style="padding: 0.5rem;">{{ submission.assignment.title }}</td>
                            <td style="padding: 0.5rem;">{{ submission.submitted_at.strftime('%Y-%m-%d %H:%M') }}</td>
                            <td style="padding: 0.5rem;">{% if submission.grade is not none %}{{ _('Graded') }}{% else %}{{ _('Ungraded') }}{% endif %}</td>
                            <td style="padding: 0.5rem;">{% if submission.grade is not none %}{{ '%.2f'|format(submission.grade) }}{% else %}-{% endif %}</td>
                            <td style="padding: 0.5rem;">
                                <div class="flex gap-1">
                                    <a href="{{ url_for('grade_submission', submission_id=submission.id) }}" class="btn btn-primary" style="font-size: 0.875rem;">{{ _('Grade') }}</a>
                                    <a href="{{ url_for('download_file', filename=submission.file_path) }}" class="btn btn-outline" style="font-size: 0.875rem;">{{ _('Download') }}</a>
                                    {% if submission.file_path and (submission.file_path.lower().endswith('.html') or submission.file_path.lower().endswith('.htm')) %}
                                        <a href="{{ url_for('serve_submission_content', filename=submission.file_path) }}" target="_blank" class="btn btn-secondary" style="font-size: 0.875rem;">{{ _('Open in new tab') }}</a>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div class="card">
            <p style="color:#666;">{{ _('No submissions') }}</p>
        </div>
    {% endif %}
    
    <h2 style="margin-bottom: 1.5rem;">{{ _('All Assignments') }}</h2>
    
    {% if assignments %}
        <div class="assignments-grid">
            {% for assignment in assignments %}
                <div class="card">
                    <div class="flex justify-between align-center mb-1">
                        <h3 style="color: var(--primary-color);">{{ assignment.title }}</h3>
                        <span style="color: #666; font-size: 0.875rem;">{{ assignment.created_at.strftime('%Y-%m-%d') }}</span>
                    </div>
                    
                    <p style="margin-bottom: 1rem; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">
                        {{ assignment.description }}
                    </p>
                    
                    <div class="flex justify-between align-center">
                        {% if assignment.file_path %}
                            <a href="{{ url_for('download_file', filename=assignment.file_path) }}" 
                               class="btn btn-outline" style="font-size: 0.875rem;">
                                {{ _('下载文件') }}
                            </a>
                        {% endif %}
                        
                        <div class="flex gap-1">
                            <a href="{{ url_for('view_submissions', assignment_id=assignment.id) }}" 
                               class="btn btn-secondary" style="font-size: 0.875rem;">
                                {{ _('查看提交') }} ({{ assignment.submissions|length }})
                            </a>

                            <form method="POST" 
                                  action="{{ url_for('delete_assignment', assignment_id=assignment.id) }}" 
                                  style="display: inline;"
                                  onsubmit="return confirm('{{ _('Delete this assignment and all submissions? This action cannot be undone.') }}');">
                                <button type="submit" 
                                        class="btn btn-secondary" 
                                        style="font-size: 0.875rem; background-color: #e74c3c; border-color: #e74c3c; color: #fff;">
                                    {{ _('Delete Assignment') }}
                                </button>
                            </form>

                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div style="text-align: center; padding: 3rem; background-color: #f9f9f9; border-radius: var(--border-radius);">
            <p style="color: #666;">{{ _('您还没有创建任何作业') }}</p>
            <a href="{{ url_for('create_assignment') }}" class="btn btn-primary mt-1">{{ _('创建第一个作业') }}</a>
        </div>
    {% endif %}
{% endblock %}